// =====================================================================================
// SISTEMA DE TRADU√á√ÉO M√âDICA - DOEN√áAS ORPHANET
// =====================================================================================
// Tradu√ß√£o especializada de doen√ßas raras para portugu√™s brasileiro
// Focado em terminologia m√©dica precisa e nomenclatura oficial
// =====================================================================================

const { PrismaClient } = require('@prisma/client');

const prisma = new PrismaClient();

// =====================================================================================
// DICION√ÅRIO ESPECIALIZADO DE DOEN√áAS RARAS
// =====================================================================================

const RARE_DISEASE_DICTIONARY = {
    // Tipos de Doen√ßas
    'syndrome': 's√≠ndrome',
    'disease': 'doen√ßa',
    'disorder': 'dist√∫rbio',
    'deficiency': 'defici√™ncia',
    'insufficiency': 'insufici√™ncia',
    'dystrophy': 'distrofia',
    'atrophy': 'atrofia',
    'sclerosis': 'esclerose',
    'stenosis': 'estenose',
    'malformation': 'malforma√ß√£o',
    'deformity': 'deformidade',
    'dysplasia': 'displasia',
    'hyperplasia': 'hiperplasia',
    'hypoplasia': 'hipoplasia',

    // Cardiomiopatias
    'cardiomyopathy': 'cardiomiopatia',
    'hypertrophic': 'hipertr√≥fica',
    'dilated': 'dilatada',
    'restrictive': 'restritiva',
    'arrhythmogenic': 'arritmog√™nica',

    // Neuropatias
    'neuropathy': 'neuropatia',
    'myopathy': 'miopatia',
    'encephalopathy': 'encefalopatia',
    'leukoencephalopathy': 'leucoencefalopatia',
    'polyneuropathy': 'polineuropatia',

    // Retinopatias e Oftalmologia
    'retinopathy': 'retinopatia',
    'retinal': 'retiniano',
    'macular': 'macular',
    'optic': '√≥ptico',
    'corneal': 'corneano',
    'cataract': 'catarata',
    'glaucoma': 'glaucoma',

    // Nefropatias
    'nephropathy': 'nefropatia',
    'nephritis': 'nefrite',
    'nephrotic': 'nefr√≥tico',
    'renal': 'renal',
    'kidney': 'renal',

    // Hepatopatias
    'hepatopathy': 'hepatopatia',
    'hepatitis': 'hepatite',
    'hepatic': 'hep√°tico',
    'liver': 'hep√°tico',
    'cirrhosis': 'cirrose',

    // Doen√ßas Metab√≥licas
    'metabolic': 'metab√≥lico',
    'lysosomal': 'lisossomal',
    'storage': 'de dep√≥sito',
    'glycogen': 'glicog√™nio',
    'lipid': 'lip√≠dico',
    'mucopolysaccharidosis': 'mucopolissacaridose',
    'sphingolipidosis': 'esfingolipidose',

    // Leucodistrofias
    'leukodystrophy': 'leucodistrofia',
    'leukoencephalopathy': 'leucoencefalopatia',
    'metachromatic': 'metacrom√°tica',
    'adrenoleukodystrophy': 'adrenoleucodistrofia',

    // Anatomia
    'congenital': 'cong√™nito',
    'hereditary': 'heredit√°rio',
    'familial': 'familiar',
    'idiopathic': 'idiop√°tico',
    'primary': 'prim√°rio',
    'secondary': 'secund√°rio',
    'acquired': 'adquirido',
    'progressive': 'progressivo',

    // Severidade
    'mild': 'leve',
    'moderate': 'moderado',
    'severe': 'grave',
    'profound': 'profundo',
    'acute': 'agudo',
    'chronic': 'cr√¥nico',
    'early': 'precoce',
    'late': 'tardio',

    // Localiza√ß√£o Anat√¥mica
    'cerebral': 'cerebral',
    'spinal': 'espinhal',
    'peripheral': 'perif√©rico',
    'central': 'central',
    'cranial': 'craniano',
    'facial': 'facial',
    'cardiac': 'card√≠aco',
    'pulmonary': 'pulmonar',
    'muscular': 'muscular',
    'skeletal': 'esquel√©tico',
    'cutaneous': 'cut√¢neo'
};

// =====================================================================================
// TRADU√á√ïES ESPEC√çFICAS DE DOEN√áAS CONHECIDAS
// =====================================================================================

const SPECIFIC_DISEASE_TRANSLATIONS = {
    // S√≠ndromes Gen√©ticas
    'Marfan syndrome': 'S√≠ndrome de Marfan',
    'Turner syndrome': 'S√≠ndrome de Turner',
    'Down syndrome': 'S√≠ndrome de Down',
    'Ehlers-Danlos syndrome': 'S√≠ndrome de Ehlers-Danlos',
    'Prader-Willi syndrome': 'S√≠ndrome de Prader-Willi',
    'Angelman syndrome': 'S√≠ndrome de Angelman',
    'DiGeorge syndrome': 'S√≠ndrome de DiGeorge',
    'Williams-Beuren syndrome': 'S√≠ndrome de Williams-Beuren',

    // Distrofias Musculares
    'Duchenne muscular dystrophy': 'Distrofia muscular de Duchenne',
    'Becker muscular dystrophy': 'Distrofia muscular de Becker',
    'Myotonic dystrophy': 'Distrofia miot√¥nica',
    'Facioscapulohumeral muscular dystrophy': 'Distrofia muscular facioescapuloumeral',
    'Limb-girdle muscular dystrophy': 'Distrofia muscular de cinturas',

    // Mucopolissacaridoses
    'Mucopolysaccharidosis type I': 'Mucopolissacaridose tipo I',
    'Mucopolysaccharidosis type II': 'Mucopolissacaridose tipo II',
    'Mucopolysaccharidosis type III': 'Mucopolissacaridose tipo III',
    'Mucopolysaccharidosis type IV': 'Mucopolissacaridose tipo IV',
    'Hunter syndrome': 'S√≠ndrome de Hunter',
    'Hurler syndrome': 'S√≠ndrome de Hurler',
    'Sanfilippo syndrome': 'S√≠ndrome de Sanfilippo',

    // Leucodistrofias
    'Metachromatic leukodystrophy': 'Leucodistrofia metacrom√°tica',
    'Adrenoleukodystrophy': 'Adrenoleucodistrofia',
    'Krabbe disease': 'Doen√ßa de Krabbe',
    'Alexander disease': 'Doen√ßa de Alexander',

    // Doen√ßas de Dep√≥sito
    'Gaucher disease': 'Doen√ßa de Gaucher',
    'Niemann-Pick disease': 'Doen√ßa de Niemann-Pick',
    'Tay-Sachs disease': 'Doen√ßa de Tay-Sachs',
    'Fabry disease': 'Doen√ßa de Fabry',
    'Pompe disease': 'Doen√ßa de Pompe',

    // Erros Inatos do Metabolismo
    'Phenylketonuria': 'Fenilceton√∫ria',
    'Galactosemia': 'Galactosemia',
    'Maple syrup urine disease': 'Doen√ßa da urina do xarope de bordo',
    'Homocystinuria': 'Homocistin√∫ria',

    // Imunodefici√™ncias
    'Severe combined immunodeficiency': 'Imunodefici√™ncia combinada grave',
    'DiGeorge syndrome': 'S√≠ndrome de DiGeorge',
    'Wiskott-Aldrich syndrome': 'S√≠ndrome de Wiskott-Aldrich',

    // Doen√ßas Card√≠acas
    'Hypertrophic cardiomyopathy': 'Cardiomiopatia hipertr√≥fica',
    'Dilated cardiomyopathy': 'Cardiomiopatia dilatada',
    'Arrhythmogenic right ventricular cardiomyopathy': 'Cardiomiopatia arritmog√™nica do ventr√≠culo direito',

    // Retinopatias
    'Leber congenital amaurosis': 'Amaurose cong√™nita de Leber',
    'Stargardt disease': 'Doen√ßa de Stargardt',
    'Retinitis pigmentosa': 'Retinose pigmentar',

    // Ataxias
    'Friedreich ataxia': 'Ataxia de Friedreich',
    'Spinocerebellar ataxia': 'Ataxia espinocerebelar',
    'Ataxia telangiectasia': 'Ataxia telangiectasia'
};

// =====================================================================================
// CLASSE DE TRADU√á√ÉO DE DOEN√áAS ORPHANET
// =====================================================================================

class OrphanetTranslator {
    constructor() {
        this.translatedCount = 0;
        this.skippedCount = 0;
        this.errorCount = 0;
        this.batchSize = 100;
    }

    // =====================================================================================
    // M√âTODO PRINCIPAL
    // =====================================================================================
    async translateAllOrphanetDiseases() {
        console.log('üß¨ INICIANDO TRADU√á√ÉO DE DOEN√áAS ORPHANET');
        console.log('=======================================\n');

        try {
            const totalDiseases = await prisma.orphaDisease.count();
            const diseasesToTranslate = await prisma.orphaDisease.count({
                where: {
                    OR: [
                        { preferredNamePt: null },
                        { preferredNamePt: '' }
                    ]
                }
            });

            console.log(`üìä Total de doen√ßas: ${totalDiseases.toLocaleString()}`);
            console.log(`üîÑ Doen√ßas para traduzir: ${diseasesToTranslate.toLocaleString()}`);
            console.log(`üìà Percentual a traduzir: ${((diseasesToTranslate / totalDiseases) * 100).toFixed(1)}%\n`);

            let offset = 0;
            while (true) {
                const batch = await this.getNextBatch(offset);
                if (batch.length === 0) break;

                await this.processBatch(batch);
                offset += this.batchSize;

                console.log(`‚úÖ Processadas ${Math.min(offset, diseasesToTranslate)} de ${diseasesToTranslate} doen√ßas...`);
            }

            await this.generateReport();

        } catch (error) {
            console.error('‚ùå Erro na tradu√ß√£o Orphanet:', error);
        } finally {
            await prisma.$disconnect();
        }
    }

    // =====================================================================================
    // BUSCAR PR√ìXIMO LOTE
    // =====================================================================================
    async getNextBatch(offset) {
        return await prisma.orphaDisease.findMany({
            where: {
                OR: [
                    { preferredNamePt: null },
                    { preferredNamePt: '' }
                ]
            },
            skip: offset,
            take: this.batchSize,
            orderBy: { preferredNameEn: 'asc' }
        });
    }

    // =====================================================================================
    // PROCESSAR LOTE
    // =====================================================================================
    async processBatch(diseases) {
        for (const disease of diseases) {
            try {
                // Traduzir nome preferido
                const translatedName = this.translateDiseaseName(disease.preferredNameEn);
                
                // Traduzir sin√¥nimos se existirem
                let translatedSynonyms = null;
                if (disease.synonymsEn) {
                    translatedSynonyms = this.translateSynonyms(disease.synonymsEn);
                }

                // Verificar se houve mudan√ßa
                const nameChanged = translatedName !== disease.preferredNameEn;
                const synonymsChanged = translatedSynonyms && translatedSynonyms !== disease.synonymsEn;

                if (nameChanged || synonymsChanged) {
                    const updateData = {};
                    if (nameChanged) updateData.preferredNamePt = translatedName;
                    if (synonymsChanged) updateData.synonymsPt = translatedSynonyms;

                    await prisma.orphaDisease.update({
                        where: { id: disease.id },
                        data: updateData
                    });

                    this.translatedCount++;
                } else {
                    this.skippedCount++;
                }

            } catch (error) {
                console.error(`‚ö†Ô∏è  Erro traduzindo ${disease.orphaNumber}: ${error.message}`);
                this.errorCount++;
            }
        }
    }

    // =====================================================================================
    // TRADUZIR NOME DA DOEN√áA
    // =====================================================================================
    translateDiseaseName(originalName) {
        // 1. Verificar tradu√ß√µes espec√≠ficas exatas
        if (SPECIFIC_DISEASE_TRANSLATIONS[originalName]) {
            return SPECIFIC_DISEASE_TRANSLATIONS[originalName];
        }

        // 2. Verificar tradu√ß√µes espec√≠ficas parciais (contendo palavras-chave)
        for (const [english, portuguese] of Object.entries(SPECIFIC_DISEASE_TRANSLATIONS)) {
            if (originalName.includes(english)) {
                return originalName.replace(english, portuguese);
            }
        }

        // 3. Aplicar dicion√°rio palavra por palavra
        let translated = originalName;
        for (const [english, portuguese] of Object.entries(RARE_DISEASE_DICTIONARY)) {
            const regex = new RegExp(`\\b${english}\\b`, 'gi');
            translated = translated.replace(regex, portuguese);
        }

        // 4. Corre√ß√µes p√≥s-tradu√ß√£o
        translated = this.applyPostTranslationCorrections(translated);

        // 5. Capitaliza√ß√£o adequada para nomes de doen√ßas
        translated = this.capitalizeDiseaseName(translated);

        return translated;
    }

    // =====================================================================================
    // TRADUZIR SIN√îNIMOS
    // =====================================================================================
    translateSynonyms(synonymsString) {
        if (!synonymsString) return null;

        // Assumindo que sin√¥nimos s√£o separados por ';' ou '|'
        const synonyms = synonymsString.split(/[;|]/).map(s => s.trim());
        const translatedSynonyms = synonyms.map(synonym => this.translateDiseaseName(synonym));
        
        return translatedSynonyms.join('; ');
    }

    // =====================================================================================
    // CORRE√á√ïES P√ìS-TRADU√á√ÉO
    // =====================================================================================
    applyPostTranslationCorrections(text) {
        const corrections = {
            // Corre√ß√µes de artigos
            's√≠ndrome de de': 's√≠ndrome de',
            'doen√ßa de de': 'doen√ßa de',
            'dist√∫rbio de de': 'dist√∫rbio de',
            'distrofia de de': 'distrofia de',
            
            // Corre√ß√µes de g√™nero
            'defici√™ncia de': 'defici√™ncia da',
            'insufici√™ncia de': 'insufici√™ncia da',
            'atrofia de': 'atrofia da',
            'displasia de': 'displasia da',
            'hiperplasia de': 'hiperplasia da',
            'hipoplasia de': 'hipoplasia da',
            
            // Corre√ß√µes espec√≠ficas
            'mucopolissacaridose de tipo': 'mucopolissacaridose tipo',
            'leucodistrofia de metacrom√°tica': 'leucodistrofia metacrom√°tica',
            'cardiomiopatia de hipertr√≥fica': 'cardiomiopatia hipertr√≥fica',
            'cardiomiopatia de dilatada': 'cardiomiopatia dilatada',
            
            // N√∫meros
            'tipo eu': 'tipo I',
            'tipo ii': 'tipo II',
            'tipo iii': 'tipo III',
            'tipo iv': 'tipo IV',
            'tipo v': 'tipo V'
        };

        let corrected = text;
        for (const [wrong, right] of Object.entries(corrections)) {
            corrected = corrected.replace(new RegExp(wrong, 'gi'), right);
        }

        return corrected;
    }

    // =====================================================================================
    // CAPITALIZAR NOME DA DOEN√áA
    // =====================================================================================
    capitalizeDiseaseName(name) {
        // Palavras que devem permanecer min√∫sculas (exceto no in√≠cio)
        const lowercaseWords = ['de', 'da', 'do', 'das', 'dos', 'e', 'ou', 'com', 'por', 'para', 'tipo'];
        
        const words = name.split(' ');
        const capitalizedWords = words.map((word, index) => {
            if (index === 0) {
                // Primeira palavra sempre mai√∫scula
                return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            } else if (lowercaseWords.includes(word.toLowerCase())) {
                // Palavras espec√≠ficas em min√∫scula
                return word.toLowerCase();
            } else if (/^[IVX]+$/.test(word)) {
                // N√∫meros romanos em mai√∫scula
                return word.toUpperCase();
            } else {
                // Outras palavras com primeira letra mai√∫scula
                return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            }
        });

        return capitalizedWords.join(' ');
    }

    // =====================================================================================
    // RELAT√ìRIO FINAL
    // =====================================================================================
    async generateReport() {
        const totalDiseases = await prisma.orphaDisease.count();
        const translatedDiseases = await prisma.orphaDisease.count({
            where: { preferredNamePt: { not: null } }
        });
        const coverage = totalDiseases > 0 ? ((translatedDiseases / totalDiseases) * 100).toFixed(1) : '0.0';

        console.log('\nüéâ TRADU√á√ÉO ORPHANET CONCLU√çDA!');
        console.log('==============================');
        console.log(`‚úÖ Doen√ßas traduzidas: ${this.translatedCount.toLocaleString()}`);
        console.log(`‚è≠Ô∏è  Doen√ßas ignoradas: ${this.skippedCount.toLocaleString()}`);
        console.log(`‚ùå Erros encontrados: ${this.errorCount.toLocaleString()}`);
        console.log(`üìä Total de doen√ßas: ${totalDiseases.toLocaleString()}`);
        console.log(`üìà Cobertura atual: ${coverage}%`);

        console.log('\nüß¨ QUALIDADE DA TRADU√á√ÉO:');
        console.log('========================');
        console.log('‚úÖ Nomenclatura m√©dica oficial preservada');
        console.log('‚úÖ Tradu√ß√µes espec√≠ficas para s√≠ndromes conhecidas');
        console.log('‚úÖ Capitaliza√ß√£o adequada para nomes pr√≥prios');
        console.log('‚úÖ Corre√ß√µes gramaticais aplicadas');

        console.log('\nüåç BENEF√çCIOS PARA COMUNIDADE M√âDICA:');
        console.log('=====================================');
        console.log('üè• Diagn√≥sticos mais acess√≠veis em portugu√™s');
        console.log('üìö Literatura m√©dica traduzida automaticamente');
        console.log('üî¨ Pesquisa facilitada para cientistas lus√≥fonos');
        console.log('üë®‚Äç‚öïÔ∏è Comunica√ß√£o m√©dico-paciente aprimorada');
    }
}

// =====================================================================================
// EXECU√á√ÉO
// =====================================================================================
async function main() {
    const translator = new OrphanetTranslator();
    await translator.translateAllOrphanetDiseases();
}

if (require.main === module) {
    main().then(() => {
        console.log('\nüéä DOEN√áAS ORPHANET MULTIL√çNGUES ATIVAS!');
        process.exit(0);
    }).catch((error) => {
        console.error('\nüí• ERRO CR√çTICO:', error);
        process.exit(1);
    });
}

module.exports = { OrphanetTranslator };
