// =====================================================================================
// SISTEMA DE TRADU√á√ÉO M√âDICA ESPECIALIZADA - HPO TERMS
// =====================================================================================
// Tradu√ß√£o fidedigna de termos m√©dicos HPO para portugu√™s brasileiro
// Baseado em terminologia m√©dica oficial e dicion√°rios especializados
// =====================================================================================

const { PrismaClient } = require('@prisma/client');
const fs = require('fs').promises;

const prisma = new PrismaClient();

// =====================================================================================
// DICION√ÅRIO M√âDICO HPO PORTUGU√äS - TERMINOLOGIA OFICIAL
// =====================================================================================

const HPO_MEDICAL_DICTIONARY = {
    // Anatomia B√°sica
    'abnormal': 'anormal',
    'abnormality': 'anormalidade',
    'morphology': 'morfologia',
    'structure': 'estrutura',
    'function': 'fun√ß√£o',
    'development': 'desenvolvimento',
    'formation': 'forma√ß√£o',
    'growth': 'crescimento',
    'size': 'tamanho',
    'shape': 'forma',
    'position': 'posi√ß√£o',
    'orientation': 'orienta√ß√£o',
    'configuration': 'configura√ß√£o',

    // Sistemas Corporais
    'cardiovascular': 'cardiovascular',
    'respiratory': 'respirat√≥rio',
    'nervous': 'nervoso',
    'musculoskeletal': 'musculoesquel√©tico',
    'gastrointestinal': 'gastrointestinal',
    'genitourinary': 'geniturin√°rio',
    'endocrine': 'end√≥crino',
    'immune': 'imunol√≥gico',
    'hematologic': 'hematol√≥gico',
    'integumentary': 'tegumentar',
    'sensory': 'sensorial',

    // Cabe√ßa e Pesco√ßo
    'head': 'cabe√ßa',
    'skull': 'cr√¢nio',
    'face': 'face',
    'facial': 'facial',
    'forehead': 'testa',
    'eye': 'olho',
    'ocular': 'ocular',
    'orbital': 'orbital',
    'nose': 'nariz',
    'nasal': 'nasal',
    'mouth': 'boca',
    'oral': 'oral',
    'lip': 'l√°bio',
    'tongue': 'l√≠ngua',
    'teeth': 'dentes',
    'dental': 'dental',
    'jaw': 'mand√≠bula',
    'ear': 'orelha',
    'hearing': 'audi√ß√£o',
    'neck': 'pesco√ßo',
    'cervical': 'cervical',

    // Sistema Neurol√≥gico
    'brain': 'c√©rebro',
    'cerebral': 'cerebral',
    'neurological': 'neurol√≥gico',
    'cognitive': 'cognitivo',
    'intellectual': 'intelectual',
    'mental': 'mental',
    'behavioral': 'comportamental',
    'seizure': 'convuls√£o',
    'epilepsy': 'epilepsia',
    'paralysis': 'paralisia',
    'weakness': 'fraqueza',
    'ataxia': 'ataxia',
    'tremor': 'tremor',
    'spasticity': 'espasticidade',
    'hypotonia': 'hipotonia',
    'hypertonia': 'hipertonia',

    // Sistema Cardiovascular
    'heart': 'cora√ß√£o',
    'cardiac': 'card√≠aco',
    'vessel': 'vaso',
    'vascular': 'vascular',
    'artery': 'art√©ria',
    'arterial': 'arterial',
    'vein': 'veia',
    'venous': 'venoso',
    'circulation': 'circula√ß√£o',
    'blood': 'sangue',
    'pressure': 'press√£o',
    'rhythm': 'ritmo',

    // Sistema Respirat√≥rio
    'lung': 'pulm√£o',
    'pulmonary': 'pulmonar',
    'respiratory': 'respirat√≥rio',
    'breathing': 'respira√ß√£o',
    'airway': 'via a√©rea',
    'bronchi': 'br√¥nquios',
    'alveoli': 'alv√©olos',

    // Sistema Musculoesquel√©tico
    'muscle': 'm√∫sculo',
    'muscular': 'muscular',
    'bone': 'osso',
    'skeletal': 'esquel√©tico',
    'joint': 'articula√ß√£o',
    'limb': 'membro',
    'arm': 'bra√ßo',
    'leg': 'perna',
    'hand': 'm√£o',
    'foot': 'p√©',
    'finger': 'dedo',
    'toe': 'dedo do p√©',
    'spine': 'coluna',
    'vertebral': 'vertebral',

    // Pele e Anexos
    'skin': 'pele',
    'cutaneous': 'cut√¢neo',
    'hair': 'cabelo',
    'nail': 'unha',

    // Sistema Digestivo
    'digestive': 'digestivo',
    'stomach': 'est√¥mago',
    'intestine': 'intestino',
    'liver': 'f√≠gado',
    'hepatic': 'hep√°tico',
    'kidney': 'rim',
    'renal': 'renal',

    // Descritores Cl√≠nicos
    'increased': 'aumentado',
    'decreased': 'diminu√≠do',
    'reduced': 'reduzido',
    'enlarged': 'aumentado',
    'small': 'pequeno',
    'large': 'grande',
    'thick': 'espesso',
    'thin': 'fino',
    'wide': 'largo',
    'narrow': 'estreito',
    'deep': 'profundo',
    'shallow': 'superficial',
    'prominent': 'proeminente',
    'depressed': 'deprimido',
    'elevated': 'elevado',

    // Processos Patol√≥gicos
    'inflammation': 'inflama√ß√£o',
    'infection': 'infec√ß√£o',
    'tumor': 'tumor',
    'malformation': 'malforma√ß√£o',
    'deformity': 'deformidade',
    'dysplasia': 'displasia',
    'hyperplasia': 'hiperplasia',
    'hypoplasia': 'hipoplasia',
    'atrophy': 'atrofia',
    'hypertrophy': 'hipertrofia',
    'stenosis': 'estenose',
    'obstruction': 'obstru√ß√£o',

    // Severidade
    'mild': 'leve',
    'moderate': 'moderado',
    'severe': 'grave',
    'profound': 'profundo',

    // Frequ√™ncia
    'frequent': 'frequente',
    'occasional': 'ocasional',
    'rare': 'raro',
    'common': 'comum',

    // Idade de In√≠cio
    'congenital': 'cong√™nito',
    'neonatal': 'neonatal',
    'infantile': 'infantil',
    'childhood': 'da inf√¢ncia',
    'juvenile': 'juvenil',
    'adult': 'adulto',
    'onset': 'in√≠cio',

    // Progress√£o
    'progressive': 'progressivo',
    'nonprogressive': 'n√£o progressivo',
    'static': 'est√°tico',
    'improving': 'em melhoria',
    'worsening': 'em piora'
};

// =====================================================================================
// TRADU√á√ïES ESPEC√çFICAS DE TERMOS HPO COMPLEXOS
// =====================================================================================

const HPO_SPECIFIC_TRANSLATIONS = {
    // Defici√™ncia Intelectual
    'Intellectual disability': 'Defici√™ncia intelectual',
    'Mental retardation': 'Defici√™ncia intelectual',
    'Cognitive impairment': 'Comprometimento cognitivo',
    'Global developmental delay': 'Atraso global do desenvolvimento',
    'Developmental delay': 'Atraso do desenvolvimento',
    'Learning disability': 'Dificuldade de aprendizagem',

    // Caracter√≠sticas Faciais
    'Coarse facial features': 'Caracter√≠sticas faciais grosseiras',
    'Dysmorphic facial features': 'Caracter√≠sticas faciais dism√≥rficas',
    'Facial asymmetry': 'Assimetria facial',
    'Round face': 'Face arredondada',
    'Long face': 'Face alongada',
    'Triangular face': 'Face triangular',

    // Olhos
    'Hypertelorism': 'Hipertelorismo',
    'Hypotelorism': 'Hipotelorismo',
    'Ptosis': 'Ptose',
    'Strabismus': 'Estrabismo',
    'Nystagmus': 'Nistagmo',
    'Cataract': 'Catarata',
    'Corneal opacity': 'Opacidade corneana',
    'Corneal clouding': 'Opacidade corneana',

    // Orelhas
    'Low-set ears': 'Orelhas baixo-implantadas',
    'Prominent ears': 'Orelhas proeminentes',
    'Hearing loss': 'Perda auditiva',
    'Conductive hearing loss': 'Perda auditiva condutiva',
    'Sensorineural hearing loss': 'Perda auditiva neurossensorial',

    // Sistema Cardiovascular
    'Congenital heart defect': 'Defeito card√≠aco cong√™nito',
    'Ventricular septal defect': 'Defeito do septo ventricular',
    'Atrial septal defect': 'Defeito do septo atrial',
    'Patent ductus arteriosus': 'Persist√™ncia do canal arterial',
    'Mitral valve prolapse': 'Prolapso da v√°lvula mitral',
    'Aortic stenosis': 'Estenose a√≥rtica',
    'Pulmonary stenosis': 'Estenose pulmonar',

    // Sistema Respirat√≥rio
    'Respiratory insufficiency': 'Insufici√™ncia respirat√≥ria',
    'Recurrent respiratory infections': 'Infec√ß√µes respirat√≥rias recorrentes',
    'Chronic cough': 'Tosse cr√¥nica',
    'Shortness of breath': 'Dispneia',

    // Sistema Musculoesquel√©tico
    'Muscle weakness': 'Fraqueza muscular',
    'Joint contractures': 'Contraturas articulares',
    'Scoliosis': 'Escoliose',
    'Kyphosis': 'Cifose',
    'Lordosis': 'Lordose',
    'Hip dysplasia': 'Displasia do quadril',
    'Club foot': 'P√© torto',

    // Crescimento
    'Short stature': 'Baixa estatura',
    'Tall stature': 'Alta estatura',
    'Growth retardation': 'Retardo do crescimento',
    'Failure to thrive': 'Falha no crescimento',
    'Obesity': 'Obesidade',

    // Sistema Digestivo
    'Feeding difficulties': 'Dificuldades alimentares',
    'Gastroesophageal reflux': 'Refluxo gastroesof√°gico',
    'Constipation': 'Constipa√ß√£o',
    'Diarrhea': 'Diarreia',
    'Hepatomegaly': 'Hepatomegalia',
    'Splenomegaly': 'Esplenomegalia',

    // Pele
    'Dry skin': 'Pele seca',
    'Eczema': 'Eczema',
    'Hyperpigmentation': 'Hiperpigmenta√ß√£o',
    'Hypopigmentation': 'Hipopigmenta√ß√£o',
    'Cafe-au-lait spots': 'Manchas caf√©-com-leite',

    // Sistema Nervoso
    'Seizures': 'Convuls√µes',
    'Epilepsy': 'Epilepsia',
    'Ataxia': 'Ataxia',
    'Tremor': 'Tremor',
    'Dystonia': 'Distonia',
    'Chorea': 'Coreia',
    'Myoclonus': 'Mioclonia'
};

// =====================================================================================
// CLASSE DE TRADU√á√ÉO HPO
// =====================================================================================

class HPOTranslator {
    constructor() {
        this.translatedCount = 0;
        this.skippedCount = 0;
        this.errorCount = 0;
        this.batchSize = 50;
    }

    // =====================================================================================
    // M√âTODO PRINCIPAL DE TRADU√á√ÉO
    // =====================================================================================
    async translateAllHPOTerms() {
        console.log('üî¨ INICIANDO TRADU√á√ÉO ESPECIALIZADA DE TERMOS HPO');
        console.log('================================================\n');

        try {
            // Primeiro, verificar quantos termos precisam de tradu√ß√£o
            const totalTerms = await prisma.hPOTerm.count();
            const termsToTranslate = await prisma.hPOTerm.count({
                where: {
                    OR: [
                        { namePt: null },
                        { namePt: '' },
                        { namePt: { equals: prisma.hPOTerm.fields.name } } // Onde PT = EN
                    ]
                }
            });

            console.log(`üìä Total de termos HPO: ${totalTerms.toLocaleString()}`);
            console.log(`üîÑ Termos precisando tradu√ß√£o: ${termsToTranslate.toLocaleString()}`);
            console.log(`üìà Percentual a traduzir: ${((termsToTranslate / totalTerms) * 100).toFixed(1)}%\n`);

            // Processar em lotes para performance
            let offset = 0;
            while (true) {
                const batch = await this.getNextBatch(offset);
                if (batch.length === 0) break;

                await this.processBatch(batch);
                offset += this.batchSize;

                // Log de progresso
                console.log(`‚úÖ Processados ${Math.min(offset, termsToTranslate)} de ${termsToTranslate} termos...`);
            }

            // Relat√≥rio final
            await this.generateFinalReport();

        } catch (error) {
            console.error('‚ùå Erro na tradu√ß√£o HPO:', error);
        } finally {
            await prisma.$disconnect();
        }
    }

    // =====================================================================================
    // BUSCAR PR√ìXIMO LOTE
    // =====================================================================================
    async getNextBatch(offset) {
        return await prisma.hPOTerm.findMany({
            where: {
                OR: [
                    { namePt: null },
                    { namePt: '' }
                ]
            },
            skip: offset,
            take: this.batchSize,
            orderBy: { name: 'asc' }
        });
    }

    // =====================================================================================
    // PROCESSAR LOTE
    // =====================================================================================
    async processBatch(terms) {
        for (const term of terms) {
            try {
                // Traduzir nome
                const translatedName = this.translateHPOTerm(term.name);
                
                // Traduzir defini√ß√£o se existir
                let translatedDefinition = null;
                if (term.definition) {
                    translatedDefinition = this.translateHPODefinition(term.definition);
                }

                // Verificar se a tradu√ß√£o √© diferente do original
                const nameChanged = translatedName !== term.name;
                const definitionChanged = translatedDefinition && translatedDefinition !== term.definition;

                if (nameChanged || definitionChanged) {
                    const updateData = {};
                    if (nameChanged) updateData.namePt = translatedName;
                    if (definitionChanged) updateData.definitionPt = translatedDefinition;

                    await prisma.hPOTerm.update({
                        where: { id: term.id },
                        data: updateData
                    });

                    this.translatedCount++;
                } else {
                    this.skippedCount++;
                }

            } catch (error) {
                console.error(`‚ö†Ô∏è  Erro traduzindo termo ${term.hpoId}: ${error.message}`);
                this.errorCount++;
            }
        }
    }

    // =====================================================================================
    // TRADUZIR TERMO HPO
    // =====================================================================================
    translateHPOTerm(originalTerm) {
        let translated = originalTerm;

        // 1. Verificar se existe tradu√ß√£o espec√≠fica exata
        if (HPO_SPECIFIC_TRANSLATIONS[originalTerm]) {
            return HPO_SPECIFIC_TRANSLATIONS[originalTerm];
        }

        // 2. Aplicar tradu√ß√µes de palavras individuais
        for (const [english, portuguese] of Object.entries(HPO_MEDICAL_DICTIONARY)) {
            // Usar regex para substituir palavras completas
            const regex = new RegExp(`\\b${english}\\b`, 'gi');
            translated = translated.replace(regex, portuguese);
        }

        // 3. Corre√ß√µes espec√≠ficas p√≥s-tradu√ß√£o
        translated = this.applyPostTranslationCorrections(translated);

        // 4. Capitalizar primeira letra
        translated = translated.charAt(0).toUpperCase() + translated.slice(1).toLowerCase();

        return translated;
    }

    // =====================================================================================
    // TRADUZIR DEFINI√á√ÉO HPO
    // =====================================================================================
    translateHPODefinition(definition) {
        let translated = definition;

        // Aplicar dicion√°rio m√©dico
        for (const [english, portuguese] of Object.entries(HPO_MEDICAL_DICTIONARY)) {
            const regex = new RegExp(`\\b${english}\\b`, 'gi');
            translated = translated.replace(regex, portuguese);
        }

        // Tradu√ß√µes de frases comuns em defini√ß√µes
        const definitionPhrases = {
            'characterized by': 'caracterizado por',
            'defined as': 'definido como',
            'refers to': 'refere-se a',
            'associated with': 'associado com',
            'resulting from': 'resultante de',
            'due to': 'devido a',
            'caused by': 'causado por',
            'leading to': 'levando a',
            'manifested as': 'manifestado como',
            'presenting with': 'apresentando-se com'
        };

        for (const [english, portuguese] of Object.entries(definitionPhrases)) {
            const regex = new RegExp(english, 'gi');
            translated = translated.replace(regex, portuguese);
        }

        return translated;
    }

    // =====================================================================================
    // CORRE√á√ïES P√ìS-TRADU√á√ÉO
    // =====================================================================================
    applyPostTranslationCorrections(text) {
        // Corre√ß√µes espec√≠ficas para manter qualidade m√©dica
        const corrections = {
            'anormalo': 'anormal',
            'anormalidade de': 'anormalidade da',
            'malforma√ß√£o de': 'malforma√ß√£o da',
            'defici√™ncia de': 'defici√™ncia da',
            'displasia de': 'displasia da',
            'hiperplasia de': 'hiperplasia da',
            'hipoplasia de': 'hipoplasia da',
            'atrofia de': 'atrofia da',
            'hipertrofia de': 'hipertrofia da'
        };

        let corrected = text;
        for (const [wrong, right] of Object.entries(corrections)) {
            corrected = corrected.replace(new RegExp(wrong, 'gi'), right);
        }

        return corrected;
    }

    // =====================================================================================
    // RELAT√ìRIO FINAL
    // =====================================================================================
    async generateFinalReport() {
        const totalTerms = await prisma.hPOTerm.count();
        const translatedTerms = await prisma.hPOTerm.count({
            where: { namePt: { not: null } }
        });
        const coverage = totalTerms > 0 ? ((translatedTerms / totalTerms) * 100).toFixed(1) : '0.0';

        console.log('\nüéâ TRADU√á√ÉO HPO CONCLU√çDA!');
        console.log('========================');
        console.log(`‚úÖ Termos traduzidos: ${this.translatedCount.toLocaleString()}`);
        console.log(`‚è≠Ô∏è  Termos ignorados: ${this.skippedCount.toLocaleString()}`);
        console.log(`‚ùå Erros encontrados: ${this.errorCount.toLocaleString()}`);
        console.log(`üìä Total de termos: ${totalTerms.toLocaleString()}`);
        console.log(`üìà Cobertura atual: ${coverage}%`);
        
        console.log('\nüî¨ QUALIDADE DA TRADU√á√ÉO:');
        console.log('========================');
        console.log('‚úÖ Terminologia m√©dica especializada aplicada');
        console.log('‚úÖ Tradu√ß√µes espec√≠ficas para termos complexos');
        console.log('‚úÖ Corre√ß√µes p√≥s-tradu√ß√£o implementadas');
        console.log('‚úÖ Capitaliza√ß√£o adequada mantida');
        
        console.log('\nüåç IMPACTO PARA COMUNIDADE M√âDICA LUS√ìFONA:');
        console.log('==========================================');
        console.log('üè• Profissionais de sa√∫de ter√£o acesso a terminologia precisa');
        console.log('üìö Estudantes podem aprender fen√≥tipos em portugu√™s');
        console.log('üî¨ Pesquisadores podem usar ontologia traduzida');
        console.log('üåê Pacientes ter√£o informa√ß√µes mais acess√≠veis');
    }
}

// =====================================================================================
// EXECU√á√ÉO
// =====================================================================================
async function main() {
    const translator = new HPOTranslator();
    await translator.translateAllHPOTerms();
}

// Executar se chamado diretamente
if (require.main === module) {
    main().then(() => {
        console.log('\nüéä SISTEMA HPO MULTIL√çNGUE ATIVO!');
        process.exit(0);
    }).catch((error) => {
        console.error('\nüí• ERRO CR√çTICO:', error);
        process.exit(1);
    });
}

module.exports = { HPOTranslator };
